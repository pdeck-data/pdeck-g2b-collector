name: G2B Auto Collector & Drive Uploader

on:
  schedule:
    - cron: "0 15 * * *" # 매일 00:00 KST
  workflow_dispatch: {}

jobs:
  g2b_job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r api-collector/collectors/g2b/requirements.txt

      - name: Export Slack/API keys to env
        run: |
          echo "SLACK_TOKEN=${{ secrets.SLACK_TOKEN }}" >> $GITHUB_ENV
          echo "SLACK_CHANNEL_ID=${{ secrets.SLACK_CHANNEL_ID }}" >> $GITHUB_ENV
          echo "API_KEY=${{ secrets.API_KEY }}" >> $GITHUB_ENV
          echo "GDRIVE_FOLDER_ID=${{ secrets.GDRIVE_FOLDER_ID }}" >> $GITHUB_ENV

      # 1. Base64 디코딩으로 인증 키 생성
      # ✅ [수정됨] Python을 사용해 안전하게 디코딩 (줄바꿈/공백 문제 원천 차단)
      - name: Create service_account.json
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          python -c "import base64, os; open('service_account.json', 'wb').write(base64.b64decode(os.environ['GOOGLE_CREDENTIALS']))"

      # 2. 로그 폴더 생성 (없으면 에러 나므로 필수)
      - name: Create Log Directory
        run: |
          mkdir -p api-collector/collectors/g2b/data/logs
          mkdir -p api-collector/collectors/g2b/data/raw

      # 3. 이어받기 파일(progress.json) 다운로드
      # (이 파일은 별도로 있어야 합니다. 없으면 코드에서 초기값으로 시작하니 패스해도 됩니다.)
      - name: Download progress.json
        run: |
          python api-collector/collectors/g2b/download_progress.py

      # 4. 메인 수집 실행 (여기서 수집 + 슬랙알림 + 파일저장 다 함)
      - name: Run G2B Collector
        run: |
          python api-collector/collectors/g2b/collect_all.py

      # 5. 업데이트된 progress.json 구글 드라이브에 백업
      - name: Upload updated progress.json
        run: |
          python api-collector/collectors/g2b/upload_progress.py

      # 6. 수집된 XML 데이터 구글 드라이브 업로드
      # (⚠️중요: 방금 보여주신 코드에는 드라이브 업로드 기능이 없습니다! 별도 파일이 있어야 합니다.)
      - name: Upload Collected Data to Drive
        run: |
          python api-collector/collectors/g2b/upload_to_drive.py
