name: G2B Auto Collector

on:
  schedule:
    - cron: "0 23 * * *"  # UTC 23:00 = KST 08:00
  workflow_dispatch:
    inputs:
      skip_connection_test:
        description: 'ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°'
        required: false
        default: 'false'
        type: boolean
      force_api_reset:
        description: 'API í˜¸ì¶œ ì¹´ìš´íŠ¸ ê°•ì œ ë¦¬ì…‹'
        required: false
        default: 'false'
        type: boolean
jobs:
  g2b-job:
    runs-on: ubuntu-latest
    
    # ğŸ”§ ì¶”ê°€: íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ë¶„)
    timeout-minutes: 30

    env:
      API_KEY: ${{ secrets.API_KEY }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      GDRIVE_PROGRESS_FILE_ID: ${{ secrets.GDRIVE_PROGRESS_FILE_ID }}
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
      
      # ğŸ”§ ì¶”ê°€: ì¶”ê°€ í™˜ê²½ë³€ìˆ˜
      PYTHONPATH: ${{ github.workspace }}
      TZ: Asia/Seoul

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          # ğŸ”§ ì¶”ê°€: pip ìºì‹±
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      # ğŸ”§ ì¶”ê°€: ì˜ì¡´ì„± í™•ì¸
      - name: Verify dependencies
        run: |
          echo "ğŸ” ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸:"
          pip list | grep -E "(requests|google|slack)"
          echo "âœ… ì˜ì¡´ì„± í™•ì¸ ì™„ë£Œ"

      - name: Create service_account.json
        run: |
          echo "ğŸ”§ Google ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ìƒì„±..."
          echo "${{ secrets.GOOGLE_CREDENTIALS }}" | base64 -d > service_account.json
          
          # ğŸ”§ ì¶”ê°€: íŒŒì¼ ìƒì„± í™•ì¸
          if [ -f "service_account.json" ]; then
            echo "âœ… service_account.json ìƒì„± ì™„ë£Œ ($(wc -c < service_account.json) bytes)"
          else
            echo "âŒ service_account.json ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: í™˜ê²½ í™•ì¸
      - name: Environment Check
        run: |
          echo "ğŸ” ì‹¤í–‰ í™˜ê²½ í™•ì¸:"
          echo "- ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "- Python ê²½ë¡œ: $(which python)"
          echo "- Python ë²„ì „: $(python --version)"
          echo "- ì‹œê°„ëŒ€: $(date)"
          echo "- PYTHONPATH: $PYTHONPATH"
          
          echo ""
          echo "ğŸ” í•„ìˆ˜ íŒŒì¼ í™•ì¸:"
          ls -la service_account.json 2>/dev/null && echo "âœ… service_account.json" || echo "âŒ service_account.json"
          ls -la requirements.txt && echo "âœ… requirements.txt" || echo "âŒ requirements.txt"
          ls -la collectors/g2b/ && echo "âœ… collectors/g2b/" || echo "âŒ collectors/g2b/"

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: ì—°ê²° í…ŒìŠ¤íŠ¸
      - name: Connection Tests
        if: ${{ !inputs.skip_connection_test }}
        run: |
          echo "ğŸ§ª ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘"
          
          # Google Drive ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ“ Google Drive ì—°ê²° í…ŒìŠ¤íŠ¸..."
          python -c "
          from utils.drive import test_drive_connection
          import sys
          if not test_drive_connection():
              print('âŒ Google Drive ì—°ê²° ì‹¤íŒ¨')
              sys.exit(1)
          print('âœ… Google Drive ì—°ê²° ì„±ê³µ')
          "
          
          # Slack ì—°ê²° í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
          echo "ğŸ’¬ Slack ì—°ê²° í…ŒìŠ¤íŠ¸..."
          python -c "
          from utils.slack import test_slack_setup
          if not test_slack_setup():
              print('âš  Slack ì—°ê²° ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)')
          else:
              print('âœ… Slack ì—°ê²° ì„±ê³µ')
          " || echo "âš  Slack í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          
          echo "âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: Download progress.json
        id: download_progress
        timeout-minutes: 5
        run: |
          echo "ğŸ“¥ Progress ë‹¤ìš´ë¡œë“œ ì‹œì‘..."
          python collectors/g2b/download_progress.py
          
          # ğŸ”§ ì¶”ê°€: ë‹¤ìš´ë¡œë“œ ê²°ê³¼ í™•ì¸
          if [ -f "progress.json" ]; then
            echo "âœ… progress.json ë‹¤ìš´ë¡œë“œ ì„±ê³µ"
            echo "ğŸ“‹ íŒŒì¼ í¬ê¸°: $(wc -c < progress.json) bytes"
            
            # progress ë‚´ìš© ê°„ë‹¨íˆ ì¶œë ¥
            echo "ğŸ“‹ í˜„ì¬ ì§„í–‰ìƒí™©:"
            python -c "
            import json
            with open('progress.json') as f:
                p = json.load(f)
            print(f\"  â””â”€ {p.get('current_job', 'Unknown')} {p.get('current_year', 0)}ë…„ {p.get('current_month', 0)}ì›”\")
            print(f\"  â””â”€ ëˆ„ì : {p.get('total_collected', 0):,}ê±´\")
            print(f\"  â””â”€ API: {p.get('daily_api_calls', 0)}/500\")
            "
          else
            echo "âŒ progress.json ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: API ë¦¬ì…‹ ì˜µì…˜
      - name: Reset API Count (Optional)
        if: ${{ inputs.force_api_reset }}
        run: |
          echo "ğŸ”„ API í˜¸ì¶œ ì¹´ìš´íŠ¸ ê°•ì œ ë¦¬ì…‹..."
          python -c "
          import json
          with open('progress.json', 'r') as f:
              progress = json.load(f)
          
          old_count = progress.get('daily_api_calls', 0)
          progress['daily_api_calls'] = 0
          
          with open('progress.json', 'w') as f:
              json.dump(progress, f, ensure_ascii=False, indent=2)
              
          print(f'API í˜¸ì¶œ ì¹´ìš´íŠ¸ ë¦¬ì…‹: {old_count} â†’ 0')
          "

      - name: Run collector
        id: run_collector
        timeout-minutes: 20
        run: |
          echo "ğŸš€ G2B ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."
          
          # ğŸ”§ ì¶”ê°€: ìƒì„¸ ë¡œê·¸ì™€ í•¨ê»˜ ì‹¤í–‰
          python collectors/g2b/collect_all.py 2>&1 | tee collection.log
          
          # ì‹¤í–‰ ê²°ê³¼ ì €ì¥ (í›„ì† ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
          echo "COLLECTION_EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Upload progress.json
        id: upload_progress
        # ğŸ”§ ìˆ˜ì •: ìˆ˜ì§‘ ì‹¤íŒ¨í•´ë„ progressëŠ” ì—…ë¡œë“œ (API ì¹´ìš´íŠ¸ ë™ê¸°í™”)
        if: always()
        timeout-minutes: 5
        run: |
          echo "ğŸ“¤ Progress ì—…ë¡œë“œ ì‹œì‘..."
          python collectors/g2b/upload_progress.py

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: ë¡œê·¸ ë¶„ì„ ë° ìš”ì•½
      - name: Analyze Results
        if: always()
        run: |
          echo "ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë¶„ì„..."
          
          COLLECTION_EXIT_CODE=${{ steps.run_collector.outputs.COLLECTION_EXIT_CODE }}
          
          if [ "$COLLECTION_EXIT_CODE" = "0" ]; then
            echo "âœ… ìˆ˜ì§‘ ì„±ê³µ"
          else
            echo "âš  ìˆ˜ì§‘ ì‹¤íŒ¨ ë˜ëŠ” ê²½ê³  (Exit Code: $COLLECTION_EXIT_CODE)"
          fi
          
          # ë¡œê·¸ íŒŒì¼ì´ ìˆìœ¼ë©´ ì£¼ìš” ì •ë³´ ì¶”ì¶œ
          if [ -f "collection.log" ]; then
            echo ""
            echo "ğŸ“‹ ìˆ˜ì§‘ ë¡œê·¸ ìš”ì•½:"
            
            # ì„±ê³µ ë©”ì‹œì§€ ì°¾ê¸°
            grep -i "ìˆ˜ì§‘.*ì„±ê³µ\|collection.*success" collection.log || echo "  â””â”€ ì„±ê³µ ë¡œê·¸ ì—†ìŒ"
            
            # ì—ëŸ¬ ë©”ì‹œì§€ ì°¾ê¸°  
            echo ""
            echo "âŒ ë°œìƒí•œ ì˜¤ë¥˜:"
            grep -i "error\|ì‹¤íŒ¨\|fail" collection.log | head -5 || echo "  â””â”€ ì˜¤ë¥˜ ì—†ìŒ"
            
            # API í˜¸ì¶œ ì •ë³´
            echo ""
            echo "ğŸ“ API í˜¸ì¶œ ì •ë³´:"
            grep -i "api.*í˜¸ì¶œ\|api.*call" collection.log | tail -3 || echo "  â””â”€ API í˜¸ì¶œ ì •ë³´ ì—†ìŒ"
          fi

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      - name: Failure Notification
        if: failure()
        run: |
          echo "ğŸš¨ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì•Œë¦¼..."
          
          # Slack ì•Œë¦¼ (ê°€ëŠ¥í•œ ê²½ìš°)
          python -c "
          from utils.slack import send_slack_message
          import os
          
          workflow_url = f\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
          
          message = '''ğŸš¨ **G2B ìë™í™” ì‹¤íŒ¨**
          
          â€¢ ì‹œê°„: ${{ steps.run_collector.outputs.COLLECTION_EXIT_CODE || 'ì•Œ ìˆ˜ ì—†ìŒ' }}
          â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}
          â€¢ ì»¤ë°‹: ${{ github.sha }}
          
          ğŸ”— ì›Œí¬í”Œë¡œìš°: ''' + workflow_url
          
          send_slack_message(message)
          " || echo "Slack ì•Œë¦¼ ì‹¤íŒ¨"

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: g2b-logs-${{ github.run_id }}
          path: |
            collection.log
            progress.json
            service_account.json
          retention-days: 7

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: ì •ë¦¬
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
          rm -f service_account.json
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"

      # ğŸ”§ ìƒˆë¡œ ì¶”ê°€: ì›Œí¬í”Œë¡œìš° ìš”ì•½
      - name: Workflow Summary
        if: always()
        run: |
          echo "ğŸ“‹ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹œì‘ ì‹œê°„: $(date -d '30 minutes ago' '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- ì¢…ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤í–‰ ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "progress.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Progress ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
            python -c "
            import json
            try:
                with open('progress.json') as f:
                    p = json.load(f)
                print(f\"- ì§„í–‰ ìœ„ì¹˜: {p.get('current_job', 'Unknown')} {p.get('current_year', 0)}ë…„ {p.get('current_month', 0)}ì›”\")
                print(f\"- ëˆ„ì  ìˆ˜ì§‘: {p.get('total_collected', 0):,}ê±´\")
                print(f\"- ì˜¤ëŠ˜ API: {p.get('daily_api_calls', 0)}/500\")
            except:
                print('- Progress ì •ë³´ ì—†ìŒ')
            " >> $GITHUB_STEP_SUMMARY
          fi