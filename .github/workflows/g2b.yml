name: G2B Auto Collector

on:
  schedule:
    - cron: "0 23 * * *" # UTC 23:00 = KST 08:00 (ë§¤ì¼ ì•„ì¹¨ 8ì‹œ ì‹¤í–‰)
  workflow_dispatch:
    inputs:
      skip_connection_test:
        description: "ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°"
        required: false
        default: false
        type: boolean
      force_api_reset:
        description: "API í˜¸ì¶œ ì¹´ìš´íŠ¸ ê°•ì œ ë¦¬ì…‹ (ì£¼ì˜)"
        required: false
        default: false
        type: boolean

jobs:
  g2b-job:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # ë¬´í•œ ë£¨í”„ ë°©ì§€

    env:
      # GitHub Secretsì—ì„œ ê°€ì ¸ì˜´
      API_KEY: ${{ secrets.API_KEY }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      GDRIVE_PROGRESS_FILE_ID: ${{ secrets.GDRIVE_PROGRESS_FILE_ID }}
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}

      # íŒŒì´ì¬ ê²½ë¡œ ì„¤ì • (ë§¤ìš° ì¤‘ìš”: utils ëª¨ë“ˆ ì¸ì‹ìš©)
      PYTHONPATH: ${{ github.workspace }}
      TZ: Asia/Seoul

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ğŸ” ë³´ì•ˆ í‚¤ ìƒì„± (Base64 ë””ì½”ë”©)
      - name: Create service_account.json
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS }}" | base64 -d > service_account.json
          if [ -s "service_account.json" ]; then
            echo "âœ… service_account.json ìƒì„± ì™„ë£Œ"
          else
            echo "âŒ service_account.json ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      # ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸ (ë“œë¼ì´ë¸Œ & ìŠ¬ë™)
      - name: Connection Tests
        if: ${{ !inputs.skip_connection_test }}
        run: |
          echo "ğŸ§ª ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸..."
          python -c "
          import sys
          from utils.drive import test_drive_connection
          if not test_drive_connection():
              print('âŒ Google Drive ì—°ê²° ì‹¤íŒ¨')
              sys.exit(1)
          print('âœ… Google Drive ì—°ê²° ì„±ê³µ')
          "

      # ğŸ“¥ Driveì—ì„œ ìƒíƒœ íŒŒì¼(progress.json) ë‹¤ìš´ë¡œë“œ
      - name: Download progress.json
        timeout-minutes: 5
        run: |
          python collectors/g2b/download_progress.py
          if [ -f "progress.json" ]; then
            echo "âœ… progress.json ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "âŒ progress.json ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì´ˆê¸° ì‹¤í–‰ì´ë©´ ë¡œì»¬ íŒŒì¼ ì‚¬ìš©)"
            # ì‹¤íŒ¨í•´ë„ ë¡œì»¬ íŒŒì¼ì´ ìˆìœ¼ë©´ ê³„ì† ì§„í–‰í•˜ë„ë¡ exit 1 ì œê±° (ì„ íƒì‚¬í•­)
          fi

      # ğŸ”„ (ì„ íƒ) API ì¹´ìš´íŠ¸ ê°•ì œ ë¦¬ì…‹
      - name: Force Reset API Count
        if: ${{ inputs.force_api_reset }}
        run: |
          python -c "
          import json
          try:
              with open('progress.json', 'r') as f:
                  data = json.load(f)
              data['daily_api_calls'] = 0
              with open('progress.json', 'w') as f:
                  json.dump(data, f)
              print('ğŸ”„ API ì¹´ìš´íŠ¸ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë¨')
          except Exception as e:
              print(f'âš  ë¦¬ì…‹ ì‹¤íŒ¨: {e}')
          "

      # ğŸš€ ë©”ì¸ ìˆ˜ì§‘ê¸° ì‹¤í–‰ (ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡í•˜ë©° ì‹¤í–‰)
      - name: Run G2B Collector
        id: run_collector
        run: |
          # í‘œì¤€ ì¶œë ¥ì„ í™”ë©´ê³¼ íŒŒì¼(collection.log)ì— ë™ì‹œì— ê¸°ë¡
          python collectors/g2b/collect_all.py 2>&1 | tee collection.log

      # ğŸ“¤ ìƒíƒœ íŒŒì¼(progress.json) Driveì— ì—…ë¡œë“œ (ì‹¤íŒ¨í•´ë„ ì‹¤í–‰)
      - name: Upload progress.json
        if: always()
        run: |
          python collectors/g2b/upload_progress.py

      # ğŸš¨ ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼ (Python ì½”ë“œê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ ëŒ€ë¹„ìš©)
      - name: Notify Failure
        if: failure()
        run: |
          python -c "
          from utils.slack import send_slack_message
          import os
          url = f'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          send_slack_message(f'ğŸš¨ **GitHub Actions ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨**\nğŸ”— ë¡œê·¸ í™•ì¸: {url}')
          " || echo "Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"

      # ğŸ“‚ ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì €ì¥ (ë””ë²„ê¹…ìš©)
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: |
            collection.log
            progress.json
          retention-days: 5
          # âš ï¸ ì£¼ì˜: service_account.jsonì€ ì ˆëŒ€ ì˜¬ë¦¬ì§€ ì•ŠìŒ!

      # ğŸ§¹ ë³´ì•ˆ íŒŒì¼ ì‚­ì œ
      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f service_account.json
          echo "ğŸ§¹ ë³´ì•ˆ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
